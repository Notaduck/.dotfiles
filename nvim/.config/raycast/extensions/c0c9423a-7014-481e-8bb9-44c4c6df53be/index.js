"use strict";var C=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var j=Object.getOwnPropertyNames;var H=Object.prototype.hasOwnProperty;var J=(s,t)=>{for(var n in t)C(s,n,{get:t[n],enumerable:!0})},ee=(s,t,n,u)=>{if(t&&typeof t=="object"||typeof t=="function")for(let d of j(t))!H.call(s,d)&&d!==n&&C(s,d,{get:()=>t[d],enumerable:!(u=X(t,d))||u.enumerable});return s};var te=s=>ee(C({},"__esModule",{value:!0}),s);var ae={};J(ae,{default:()=>v});module.exports=te(ae);var i=require("@raycast/api"),M=require("child_process");var ie=["B","kB","MB","GB","TB","PB","EB","ZB","YB"],se=["B","KiB","MiB","GiB","TiB","PiB","EiB","ZiB","YiB"],re=["b","kbit","Mbit","Gbit","Tbit","Pbit","Ebit","Zbit","Ybit"],oe=["b","kibit","Mibit","Gibit","Tibit","Pibit","Eibit","Zibit","Yibit"],$=(s,t,n)=>{let u=s;return typeof t=="string"||Array.isArray(t)?u=s.toLocaleString(t,n):(t===!0||n!==void 0)&&(u=s.toLocaleString(void 0,n)),u};function x(s,t){if(!Number.isFinite(s))throw new TypeError(`Expected a finite number, got ${typeof s}: ${s}`);t={bits:!1,binary:!1,space:!0,...t};let n=t.bits?t.binary?oe:re:t.binary?se:ie,u=t.space?" ":"";if(t.signed&&s===0)return` 0${u}${n[0]}`;let d=s<0,y=d?"-":t.signed?"+":"";d&&(s=-s);let l;if(t.minimumFractionDigits!==void 0&&(l={minimumFractionDigits:t.minimumFractionDigits}),t.maximumFractionDigits!==void 0&&(l={maximumFractionDigits:t.maximumFractionDigits,...l}),s<1){let A=$(s,t.locale,l);return y+A+u+n[0]}let b=Math.min(Math.floor(t.binary?Math.log(s)/Math.log(1024):Math.log10(s)/3),n.length-1);s/=(t.binary?1024:1e3)**b,l||(s=s.toPrecision(3));let w=$(Number(s),t.locale,l),T=n[b];return y+w+u+T}var m=require("react");var S=require("react"),ne=()=>{};function ce(s,t){let n=(0,S.useRef)(ne);(0,S.useEffect)(()=>{n.current=s},[s]),(0,S.useEffect)(()=>{if(n.current(),(t??0)>0){let d=Math.max(t??0,1e3),y=setInterval(()=>n.current(),d);return()=>clearInterval(y)}},[t])}var F=ce;var p=require("react/jsx-runtime");function v(){let[s,t]=(0,m.useState)([]),[n,u]=(0,m.useState)([]),[d,y]=(0,m.useState)(""),l=(0,i.getPreferenceValues)(),b=l.shouldSearchInPaths,w=l.shouldSearchInPid,T=l.shouldPrioritizeAppsWhenFiltering,A=l.shouldShowPID,k=l.shouldShowPath,R=+l.refreshDuration,K=l.closeWindowAfterKill,D=l.clearSearchBarAfterKill,U=l.goToRootAfterKill,[E,W]=(0,m.useState)(l.sortByMem?"memory":"cpu"),[P,Y]=(0,m.useState)(l.aggregateApps),L=()=>{(0,M.exec)("ps -eo pid,ppid,pcpu,rss,comm",(e,c)=>{if(e!=null)return;let a=c.split(`
`).map(g=>{let N=["","","","","",""],B=/(\d+)\s+(\d+)\s+(\d+[.|,]\d+)\s+(\d+)\s+(.*)/,[,r,f,o,h,I]=g.match(B)??N,q=I.match(/[^/]*[^/]*$/i)?.[0]??"",O=I.includes(".prefPane"),Q=I.includes(".app/");return{id:parseInt(r),pid:parseInt(f),cpu:parseFloat(o),mem:parseInt(h),type:O?"prefPane":Q?"app":"binary",path:I,processName:q}}).filter(g=>g.processName!=="");t(a)})};F(L,R),(0,m.useEffect)(()=>{let e=s;P&&(e=V(e)),e.sort((c,a)=>E==="memory"?c.mem>a.mem?-1:1:c.cpu>a.cpu?-1:1),u(e)},[s,E,P]);let G=e=>e.type==="prefPane"?{fileIcon:e.path?.replace(/(.+\.prefPane)(.+)/,"$1")??""}:e.type==="app"||e.type==="aggregatedApp"?{fileIcon:e.path?.replace(/(.+\.app)(.+)/,"$1")??""}:"/System/Library/CoreServices/CoreTypes.bundle/Contents/Resources/ExecutableBinaryIcon.icns",Z=e=>{(0,M.exec)(`kill -9 ${e.id}`),t(n.filter(c=>c.id!==e.id)),K&&(0,i.closeMainWindow)(),U&&(0,i.popToRoot)({clearSearchBar:D}),D&&(0,i.clearSearchBar)({forceScrollToTop:!0}),(0,i.showToast)({title:`Killed ${e.processName==="-"?`process ${e.id}`:e.processName}`,style:i.Toast.Style.Success})},_=e=>{let c=[];return e.type==="aggregatedApp"&&e.appName!=null&&c.push(e.appName),A&&c.push(e.id.toString()),k&&c.push(e.path),c.join(" - ")},V=e=>{let c=Array(),a=new Map;a.set(1,{process:{id:1},childNodes:[]});let g=Array();e.forEach(r=>{if(r.type==="app"){g.push(r.id);let f=a.get(r.id);f==null?(f={process:r,childNodes:[]},a.set(r.id,f)):f.process=r;let o=a.get(r.pid);if(o==null)o={process:void 0,childNodes:[f]},a.set(r.pid,o);else if(o.process==null)o.childNodes.push(f);else{let h;for(;o?.process!=null&&o.process.pid!==1&&(h=a.get(o.process.pid))!=null;)o=h;o?.childNodes.push(f)}o.process?.id!==1&&(o.childNodes=o.childNodes.concat(f.childNodes),f.childNodes=[])}else c.push(r)});let N=a.get(1)?.childNodes,B=Array();return N?.forEach(r=>{if(r.process==null)return;B.push(r.process.id);let f=r.childNodes.map(o=>o.process?.id).filter(o=>o!=null);B=B.concat(f),c.push({id:r.process.id,pid:r.process.pid,cpu:(r.childNodes?.reduce((o,h)=>o+(h.process?.cpu??0),0)??0)+r.process.cpu,mem:(r.childNodes?.reduce((o,h)=>o+(h.process?.mem??0),0)??0)+r.process.mem,type:"aggregatedApp",path:r.process.path,processName:r.process.processName,appName:r.process.path.match(/(?<=\/)[^/]+(?=\.app\/)/)?.[0]})}),c},z=n.length;return(0,p.jsx)(i.List,{isLoading:n.length===0,searchBarPlaceholder:"Filter by name",onSearchTextChange:e=>y(e),searchBarAccessory:(0,p.jsx)(i.List.Dropdown,{tooltip:"Filter",storeValue:!0,onChange:e=>W(e),children:(0,p.jsxs)(i.List.Dropdown.Section,{title:"Sort By",children:[(0,p.jsx)(i.List.Dropdown.Item,{title:"CPU Usage",value:"cpu"}),(0,p.jsx)(i.List.Dropdown.Item,{title:"Memory Usage",value:"memory"})]})}),children:(0,p.jsx)(i.List.Section,{title:"Processes",subtitle:`${z} running`,children:n.filter(e=>{if(d==="")return!0;let c=e.processName.toLowerCase().includes(d.toLowerCase()),a=b&&e.path.toLowerCase().match(new RegExp(`.+${d}.*\\.[app|framework|prefpane]`,"ig"))!=null,g=w&&e.id.toString().includes(d),N=e.type==="aggregatedApp"&&e.appName?.toLowerCase().includes(d.toLowerCase());return c||a||g||N}).sort((e,c)=>{if(T){let a=["app","aggregatedApp"];if(a.includes(e.type)&&!a.includes(c.type))return-1;if(!a.includes(e.type)&&a.includes(c.type))return 1}return 0}).map((e,c)=>{let a=G(e);return(0,p.jsx)(i.List.Item,{title:e.processName,subtitle:_(e),icon:a,accessories:[{text:`${e.cpu.toFixed(2)}%`,icon:{source:"cpu.svg",tintColor:i.Color.PrimaryText},tooltip:"% CPU"},{text:x(e.mem*1024),icon:{source:"memorychip.svg",tintColor:i.Color.PrimaryText},tooltip:"Memory"}],actions:(0,p.jsxs)(i.ActionPanel,{children:[(0,p.jsx)(i.Action,{title:"Kill",icon:i.Icon.XMarkCircle,onAction:()=>Z(e)}),e.path==null?null:(0,p.jsx)(i.Action.CopyToClipboard,{title:"Copy Path",content:e.path}),(0,p.jsx)(i.Action,{title:"Reload",icon:i.Icon.ArrowClockwise,shortcut:{key:"r",modifiers:["cmd"]},onAction:()=>L()}),(0,p.jsx)(i.Action,{title:`${P?"Disable":"Enable"} Aggregating Apps`,icon:i.Icon.AppWindow,shortcut:{key:"tab",modifiers:["shift"]},onAction:()=>{Y(!P),(0,i.showToast)({title:`${P?"Disabled":"Enabled"} aggregating apps`})}})]})},c)})})})}
